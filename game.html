<html>
	<head>
		<title>Game</title>
		<style>
		body {
			font-family: Monospace;
			background-color: #f0f0f0;
			margin: 0px;
			overflow: hidden;
		}
		
		canvas { 
			width: 100%; 
			height: 100%;
		}
		</style>
		<script src="lib/three.min.js"></script>
		<script src="lib/stats.min.js"></script>
		<script src="lib/OBJLoader.js"></script>
		<script src="lib/MTLLoader.js"></script>
		<script src="lib/OrbitControls.js"></script>
		<script src="http://dat-gui.googlecode.com/git/build/dat.gui.min.js"></script>
	</head>
	<body>
		
		<script>
//==========VARIABLES================================================
			var camera1, camera2, scene, renderer;
			var asteroid;
			var asteroids = new Array();

			var moveState = { up: 0, down: 0, left: 0, right: 0, forward: 0, back: 0, pitchUp: 0, pitchDown: 0, yawLeft: 0, yawRight: 0, rollLeft: 0, rollRight: 0 };

			var currentCamera = {
				cam : "cam1"
			}

			var Player ={
				mesh : new THREE.Mesh(),
				targets : new Array(),
				shots : new Array(),
				move : new THREE.Vector3(0,0,0),
				roll : new THREE.Vector3(0,0,0),
				is_alive : true,
				objLoad : false,
				rays : [
				    new THREE.Vector3(0, 0, 1),
				    new THREE.Vector3(1, 0, 1),
				    new THREE.Vector3(1, 0, 0),
				    new THREE.Vector3(1, 0, -1),
				    new THREE.Vector3(0, 0, -1),
				    new THREE.Vector3(-1, 0, -1),
				    new THREE.Vector3(-1, 0, 0),
				    new THREE.Vector3(-1, 0, 1),
				    new THREE.Vector3(0, 1, 0),	//up
				    new THREE.Vector3(0, -1, 0)	//down
				],

				LoadObj : function (path){
					var mtlLoader = new THREE.MTLLoader();
					mtlLoader.load( 
						path+'.mtl', 
						function( materials ) {
							materials.preload();
							var objLoader = new THREE.OBJLoader();
							objLoader.setMaterials( materials );
							objLoader.load( 
								path+'.obj', 
								function ( mesh ) {	// onload
									Player.mesh=mesh;
									Player.objLoad=true;
									scene.add(Player.mesh);
								}
							);
						}
					);
				},

				create : function (){
					this.LoadObj("models/starwars-tie-fighter");
					
				},

				fire : function (){
					this.shots.push(new Laser());
					this.shots[this.shots.length-1].createLaser(this.mesh);

				},

				checkCollisions : function (){
		 		var raycast = new THREE.Raycaster();
			 		for (var i = 0; i < this.rays.length; i++) {
						raycast.set(this.mesh.position,this.rays[i]);
						var collisions = raycast.intersectObjects(this.targets,true);
						if(collisions.length>0 && collisions[0].distance<=3)
						{
							scene.remove(this.mesh);
							this.is_alive=false;
							console.log("hit player");
						}
					}
				},
		 	
				update : function(){
					if(this.objLoad && this.is_alive){
						this.mesh.quaternion.setFromEuler(new THREE.Euler(
							this.roll.x*(Math.PI/2),
							this.roll.y*(Math.PI),
							this.roll.z,
							'ZYX' ));
						this.mesh.translateX(this.move.x);
						this.mesh.translateZ(this.move.z);
						
						this.move.x/=1.05;
						this.move.z/=1.05;
						this.checkCollisions();

						//LASER-loop-----------------------
						for(var i=0;i<this.shots.length;i++){
							this.shots[i].update();
							this.shots[i].CheckLaserCollision(this.targets);
						}
					}
				}
			};
			init();
			render();

			
//==========FUNCTIONS============================================================================
			function init() {
				clock = new THREE.Clock();
				renderer = new THREE.WebGLRenderer();
				renderer.setSize(window.innerWidth, window.innerHeight);
				document.body.appendChild(renderer.domElement);

				//CAMERAS----------------------------------------------------------------------------------------
				camera1 = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
				camera1.position.x = 2*(Math.PI)
				camera1.position.z = 10;
				camera2 = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
				camera2.position.set(0,0,0);	
				
				//Controls----------------------------------------------------------		
				controls = new THREE.OrbitControls( camera1, renderer.domElement);
				controls.enableDamping = true;
				controls.dampingFactor = 0.25;
				controls.enableZoom = true;

				scene = new THREE.Scene();

				//Player-test-------------------------------------------------------
				Player.create();

				//Asteroid-Test-----------------------------------------------------
				asteroid = new Asteroid();
				asteroid.position.x=-20;
				asteroid.move_active=false;
				asteroid.roll.active=false;
				asteroid.roll.x=1;
				asteroid.roll.y=1;
				// var point=[
				// 	new THREE.Vector3(-20,0,0),
				// 	new THREE.Vector3(20,0,0)
				//  ];
				var point=[
					new THREE.Vector3(-20,5,0),
					new THREE.Vector3(-10,-5,0),
					new THREE.Vector3(0,5,0),
					new THREE.Vector3(10,-5,0),
					new THREE.Vector3(20,5,0)
				];
				asteroid.direction(point);
				asteroid.radius=5;
				scene.add(asteroid.createAsteroid());
				Player.targets.push(asteroid.asteroid_mesh);
				// for (var i = 0; i <20; i++) {	
				// 	asteroids.push(new Asteroid());
				// 	asteroids[i].position.z=-8*i;
				// 	console.log(asteroids[i].position.z)
				// 	var randomPoints = [];
				// 	for ( var j = 0; j < 100; j ++ ) {
				// 	    randomPoints.push(
				// 	        new THREE.Vector3(Math.random() * 200 - 100, Math.random() * 200 - 100, Math.random() * 200 - 100)
				// 	    );
				// 	}
				// 	asteroids[i].direction(randomPoints);
				// 	asteroids[i].radius=3;
				// 	asteroids[i].move_active=true;
				// 	asteroids[i].roll.active=true;
				// 	asteroids[i].roll.x=1;
				// 	asteroids[i].roll.y=1;
				// 	//if(asteroids[i] != undefined)
				// 	scene.add(asteroids[i].createAsteroid());
				// }
			 	
				//LIGHT------------------------------------------
			 	var ambientLight = new THREE.AmbientLight( 0x444444 );
				scene.add( ambientLight );

				var directLight = new THREE.DirectionalLight( 0xffffff ,0.5);
				directLight.position.set(0,0,5);
				scene.add( directLight );

				//STATS-------------------------------------------
				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				document.body.appendChild( stats.domElement );

			}//init-end

			//GUI-------------------------------------				
			window.onload = function() {
				var gui = new dat.GUI();
				gui.add(currentCamera, 'cam', { inspect: "cam1", player: "cam2"} );
				//gui.add(asteroid, 'move_active');
				//gui.add(asteroid.roll, 'active');
  			}
  			function cameraSelector() {
				if (currentCamera.cam=="cam1"){
					return camera1;
				} else if (currentCamera.cam=="cam2"){
					return camera2;
				}
			}

  			window.addEventListener('keydown', function(event) {
  				if(currentCamera.cam=="cam2"){
					switch (event.keyCode) {
						case 65: // Left
							Player.move.x+=0.1;
						break;
						case 87: // Up
							Player.move.z+=0.1;
						break;
						case 68: // Right
							Player.move.x-=0.1;
						break;
						case 83: // Down
							Player.move.z-=0.1;
						break;
						case 69: // Down
							Player.fire();
						break;

					}
				}
	  		})
  			//-----Resize-------------------------
  			window.addEventListener( 'resize', onWindowResize, true);
  			function onWindowResize() {
				camera1.aspect = window.innerWidth / window.innerHeight;
				camera1.updateProjectionMatrix();
				camera2.aspect = window.innerWidth / window.innerHeight;
				camera2.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
			}
			//Mouse-Functions--------------------------------------------------------
  			function updateRotationVector() {
	  			if(currentCamera.cam=="cam2"){
					Player.roll.x = ( + moveState.pitchDown - moveState.pitchUp );
					Player.roll.y = ( - moveState.yawRight  + moveState.yawLeft );
					Player.roll.z = ( - moveState.rollRight + moveState.rollLeft );
				}	
			}
			mouseup = function( event ) {
				event.preventDefault();
				event.stopPropagation();
				if (window.dragToLook ) {
					window.mouseStatus --;
					moveState.yawLeft = moveState.pitchDown = 0;
				} else {
					switch ( event.button ) {
						case 0: moveState.forward = 0; break;
						case 2: moveState.back = 0; break;
					}
					updateMovementVector();
				}
				updateRotationVector();
			};
			window.onmousemove = function( event ) {
				var container = this.getContainerDimensions();
				var halfWidth  = container.size[ 0 ] / 2;
				var halfHeight = container.size[ 1 ] / 2;
				moveState.yawLeft   = - ( ( event.pageX) - halfWidth  ) / halfWidth;
				moveState.pitchDown =   ( ( event.pageY) - halfHeight ) / halfHeight;
				updateRotationVector();
			}
			window.getContainerDimensions = function() {
				return {
					size	: [ window.innerWidth, window.innerHeight ],
					offset	: [ 0, 0 ]
				};
			};
	
			//RENDER--------------------------------------------------------------------------
			function render() {
				requestAnimationFrame(render);
				
				stats.update();
				
				if(asteroid != undefined){
					asteroid.update();
				}
				Player.update();
				var relativeCameraOffset = new THREE.Vector3 (0,5,-10);
				var cameraOffset = relativeCameraOffset.applyMatrix4( Player.mesh.matrixWorld );
				camera2.position.x = cameraOffset.x;
				camera2.position.y = cameraOffset.y;
				camera2.position.z = cameraOffset.z;
				camera2.rotation.y = 90 * Math.PI / 180;
				camera2.rotation.z = Math.PI;
				camera2.lookAt(Player.mesh.position);
				
				renderer.render(scene, cameraSelector());
			}

//===========OBJECT======================================================

//====ASTEROID===========================================================
			function Asteroid () {	// constructor asteroid
				this.d_inc = 20;	//% max increase
				this.d_dec = 20;	//% max decrease
				this.radius = 1;
				this.detail = 2;
				this.position = {
					x : 0,
					y : 0,
					z : 0
				};
				this.roll = {
					active : true,
					x : 0,	// rad/30
					y : 0,
					z : 0,
					max : 10,
					min : -10
				};			
				this.move_active = true;
				this.visible = true;
				this.n_steps = 400;
				this.step = 0;
				this.material = new THREE.MeshLambertMaterial({
														color : 0x757778,
														emissive : 0x222222
														});
				this.spline = new THREE.CatmullRomCurve3();
				this.asteroid_mesh = new THREE.Mesh();
				this.direction = function(point){
					this.spline = new THREE.CatmullRomCurve3(point);

				};
				this.createAsteroid = function(){
					var asteroid_geo = this.AsteroidGeometry(this.radius,this.detail, this.d_inc,this.d_dec);
				    this.asteroid_mesh = new THREE.Mesh(asteroid_geo, this.material);
					this.asteroid_mesh.position.set(this.position.x,
													this.position.y,
													this.position.z);
					this.asteroid_mesh.visible=this.visible;
					return this.asteroid_mesh;
				};
				this.AsteroidGeometry = function (radius , detail, inc , dec){
					var octahedron_geo = new THREE.OctahedronGeometry(radius,detail);
					for(var i=0;i<octahedron_geo.vertices.length;i++){
						var v_a = octahedron_geo.vertices[i].toArray();
						var ran_value=Math.random()*((1+inc/100)-(1-dec/100))+(1-dec/100);	
						octahedron_geo.vertices[i]=new THREE.Vector3(v_a[0]*ran_value,
																	 v_a[1]*ran_value,
																	 v_a[2]*ran_value);
					}
					return octahedron_geo;
				};
				this.update = function (){
					if(this.move_active==true){
						if(this.step>this.n_steps)
						this.step=0;
						var camPos = this.spline.getPoint(this.step++ / this.n_steps);
						this.position.x = camPos .x;
						this.position.y = camPos .y;
						this.position.z = camPos .z;
					}
					if(this.roll.active){
						this.asteroid_mesh.rotation.x+= (this.roll.x/60);
						this.asteroid_mesh.rotation.y+= (this.roll.y/60);
						this.asteroid_mesh.rotation.z+= (this.roll.z/60);
					}
					this.asteroid_mesh.position.set(this.position.x,
													this.position.y,
													this.position.z);
					this.asteroid_mesh.visible=this.visible;
				};
			}
//=====END=ASTEROID======================================================

//=========LASER=========================================================
		 	function Laser() {
		 		this.move_active = true;
		 		this.geometry = new THREE.CylinderGeometry( 0.03, 0.03, 1, 32 );
		 		this.material = new THREE.MeshPhongMaterial({
													color : 0xff0000,
													emissive :0xca0000,
													shininess :100
												});
		 		this.laser_mesh = new THREE.Mesh(this.geometry, this.material);
		 		this.spline = new THREE.CatmullRomCurve3();
		 		this.rays = [new THREE.Vector3(0,0,1)];
		 		this.n_steps = 200;
		 		this.step = 0;
		 		this.createLaser = function(player){
		 			var relativeLaserOffset = new THREE.Vector3 (0.35,-0.95, 8);
					var laserOffset = relativeLaserOffset.applyMatrix4( player.matrixWorld );
					this.laser_mesh.position.x = laserOffset.x;
					this.laser_mesh.position.y = laserOffset.y;
					this.laser_mesh.position.z = laserOffset.z;

					//set fire tragectory
					var v=new THREE.Vector3(0,0,1);
					
					v.x+=this.laser_mesh.position.x;
					v.y+=this.laser_mesh.position.y;
					v.z+=this.laser_mesh.position.z;
					console.log("----------");
					console.log(v);
						// Math.sin(Player.roll.y*(Math.PI)),
						// 1,
						// Math.sin(Player.roll.x*(Math.PI)/2));
					v.applyEuler(new THREE.Euler(
						Player.roll.x*(Math.PI/2),
						Player.roll.y*(Math.PI),
						Player.roll.z,
						'ZYX' ));
					console.log(v);
					v.x*=2;
					v.y*=2;
					v.z*=2;
					console.log(v);
					this.spline = new THREE.CatmullRomCurve3([
																this.laser_mesh.position,
																v
															]);
					scene.add(this.laser_mesh);
		 		};
		 		this.update = function(){
		 			if(this.move_active==true){
		 				if(this.step>this.n_steps)this.move_active=false;
						var pos= this.spline.getPoint(this.step++ / this.n_steps);
						this.laser_mesh.position.x=pos.x;
						this.laser_mesh.position.y=pos.y;
						this.laser_mesh.position.z=pos.z;
					}
		 		};
		 		this.CheckLaserCollision = function(targets){
			 		var raycast = new THREE.Raycaster();
			 		for (var i = 0; i < targets.length; i++) {
						raycast.set(this.laser_mesh.position,this.rays[0]);
						var collisions = raycast.intersectObjects([targets[i]],true);
						if(collisions.length>0 && collisions[0].distance<=1)
						{
							console.log("asteroid HIT");
							scene.remove(targets[i]);
							targets.splice(i,1);
						}
					}
		 		};

		 	}
//======END=LASER=======================================================

		</script>
	</body>
</html>